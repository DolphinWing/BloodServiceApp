<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AppUi.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">dolphin.android.apps.BloodServiceApp.ui</a> &gt; <span class="el_source">AppUi.kt</span></div><h1>AppUi.kt</h1><pre class="source lang-java linenums">package dolphin.android.apps.BloodServiceApp.ui

import android.annotation.SuppressLint
import androidx.compose.animation.Crossfade
import androidx.compose.foundation.ExperimentalFoundationApi
import androidx.compose.foundation.background
import androidx.compose.foundation.isSystemInDarkTheme
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.BoxScope
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.requiredHeight
import androidx.compose.material.CircularProgressIndicator
import androidx.compose.material3.ExperimentalMaterial3Api
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.dynamicDarkColorScheme
import androidx.compose.material3.dynamicLightColorScheme
import androidx.compose.runtime.Composable
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.livedata.observeAsState
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.unit.Dp
import androidx.compose.ui.unit.dp
import androidx.core.os.BuildCompat
import dolphin.android.apps.BloodServiceApp.AppDataModel
import dolphin.android.apps.BloodServiceApp.provider.BloodCenter
import dolphin.android.apps.BloodServiceApp.provider.DonateActivity
import dolphin.android.apps.BloodServiceApp.provider.DonateDay
import dolphin.android.apps.BloodServiceApp.provider.SpotInfo
import dolphin.android.apps.BloodServiceApp.provider.SpotList
import dolphin.android.util.DebugOnlyNoCoverage

/**
 * Main theme of the app.
 *
 * @param content page content
 */
@SuppressLint(&quot;NewApi&quot;)
@Composable
fun AppTheme(
<span class="pc bfc" id="L46" title="All 2 branches covered.">    dark: Boolean = isSystemInDarkTheme(),</span>
<span class="pc bnc" id="L47" title="All 4 branches missed.">    dynamic: Boolean = BuildCompat.isAtLeastS(),</span>
    content: @Composable BoxScope.() -&gt; Unit
<span class="pc bpc" id="L49" title="14 of 28 branches missed.">) {</span>
<span class="fc" id="L50">    val colorScheme = when {</span>
<span class="fc bfc" id="L51" title="All 4 branches covered.">        dynamic &amp;&amp; dark -&gt; dynamicDarkColorScheme(LocalContext.current)</span>
<span class="pc bpc" id="L52" title="1 of 4 branches missed.">        dynamic &amp;&amp; !dark -&gt; dynamicLightColorScheme(LocalContext.current)</span>
<span class="fc bfc" id="L53" title="All 2 branches covered.">        dark -&gt; AppDarkThemeColors</span>
<span class="fc" id="L54">        else -&gt; AppLightThemeColors</span>
    }

<span class="fc" id="L57">    MaterialTheme(</span>
<span class="fc" id="L58">        colorScheme = colorScheme,</span>
<span class="fc" id="L59">        typography = AppTypography,</span>
<span class="fc" id="L60">    ) {</span>
<span class="pc bpc" id="L61" title="2 of 4 branches missed.">        Box(</span>
<span class="fc" id="L62">            modifier = Modifier.fillMaxSize(),</span>
<span class="fc" id="L63">            content = content,</span>
<span class="fc" id="L64">            contentAlignment = Alignment.Center, // default alignment</span>
<span class="nc" id="L65">        )</span>
<span class="fc" id="L66">    }</span>
<span class="pc bpc" id="L67" title="1 of 2 branches missed.">}</span>

/**
 * Common separator.
 *
 * @param modifier [Modifier] to apply to this layout node.
 * @param horizontalPadding horizontal padding
 * @param verticalPadding vertical padding
 * @param color separator line color
 */
@Composable
fun Separator(
<span class="fc bfc" id="L79" title="All 2 branches covered.">    modifier: Modifier = Modifier,</span>
<span class="fc" id="L80">    horizontalPadding: Dp = 8.dp,</span>
<span class="fc" id="L81">    verticalPadding: Dp = 4.dp,</span>
<span class="pc bnc" id="L82" title="All 6 branches missed.">    color: Color = MaterialTheme.colorScheme.outline.copy(alpha = .25f),</span>
<span class="pc bpc" id="L83" title="18 of 34 branches missed.">) {</span>
<span class="fc" id="L84">    Spacer(</span>
<span class="fc" id="L85">        modifier = modifier</span>
<span class="fc" id="L86">            .fillMaxWidth()</span>
<span class="fc" id="L87">            .padding(horizontal = horizontalPadding)</span>
<span class="fc" id="L88">            .background(color)</span>
<span class="fc" id="L89">            .requiredHeight(1.dp)</span>
<span class="fc" id="L90">            .padding(vertical = verticalPadding)</span>
    )
<span class="pc bfc" id="L92" title="All 2 branches covered.">}</span>

/**
 * App UI callbacks
 */
interface AppUiCallback :
    WelcomeUiCallback,
    MainUiCallback,
    SpotListUiCallback,
    SettingsUiCallback {

    /**
     * Callback when user press BACK button on UI.
     */
    fun pressBack()

    /**
     * Review data source in a browser
     *
     * @param center target blood center
     */
    fun reviewSource(center: BloodCenter.Center)
}

enum class UiState {
<span class="fc" id="L117">    Welcome, Main, Settings, Spots</span>
}

/**
 * App UI in Compose way.
 *
 * @param model data model that contains all essential data
 * @param center a [BloodCenter] instance that loads all translations
 * @param callback a interface to interact with the main controller (usually a Activity or Fragment)
 * @param modifier [Modifier] to apply to this layout node.
 */
@SuppressLint(&quot;NewApi&quot;)
@ExperimentalMaterial3Api
@ExperimentalFoundationApi
@Composable
fun AppUiPane(
    model: AppDataModel,
    center: BloodCenter,
    callback: AppUiCallback,
<span class="nc" id="L136">    modifier: Modifier = Modifier,</span>
<span class="pc bpc" id="L137" title="1 of 2 branches missed.">) {</span>
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">    AppTheme(dark = model.darkMode.collectAsState().value) {</span>
<span class="pc bpc" id="L139" title="1 of 4 branches missed.">        val selected = model.center.observeAsState()</span>
<span class="fc" id="L140">        val maps = model.storageMap.collectAsState()</span>
<span class="fc" id="L141">        val days = model.daysList.collectAsState()</span>
<span class="fc" id="L142">        val cities = model.spotList.collectAsState()</span>
<span class="fc" id="L143">        val city = model.city.collectAsState()</span>
<span class="fc" id="L144">        val review = model.showPrivacyReview.collectAsState()</span>

<span class="fc" id="L146">        Crossfade(</span>
<span class="fc" id="L147">            targetState = model.uiState.observeAsState().value,</span>
<span class="fc" id="L148">            modifier = modifier</span>
<span class="fc" id="L149">        ) { state -&gt;</span>
<span class="pc bpc" id="L150" title="3 of 11 branches missed.">            when (state) {</span>
                UiState.Welcome -&gt;
<span class="fc" id="L152">                    WelcomeUi(</span>
<span class="fc" id="L153">                        list = center.values(),</span>
<span class="nc" id="L154">                        onComplete = { index -&gt; callback.reviewComplete(center.values()[index]) },</span>
<span class="fc" id="L155">                        modifier = Modifier.fillMaxSize(),</span>
<span class="nc" id="L156">                        onReview = { callback.reviewPrivacy() },</span>
<span class="nc" id="L157">                        onSource = { callback.reviewSource(center.main()) },</span>
                    )

                UiState.Main -&gt;
<span class="nc" id="L161">                    MainUi(</span>
<span class="nc" id="L162">                        centers = center.values(),</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">                        selected = selected.value ?: center.main(),</span>
<span class="nc" id="L164">                        modifier = Modifier.fillMaxSize(),</span>
<span class="nc" id="L165">                        daysList = days.value,</span>
<span class="nc" id="L166">                        storageMap = maps.value,</span>
<span class="nc" id="L167">                        onCenterChange = { c -&gt; callback.changeBloodCenter(c) },</span>
<span class="nc" id="L168">                        onAddCalendar = { event -&gt; callback.addToCalendar(event) },</span>
<span class="nc" id="L169">                        enableAddCalendar = callback.enableAddToCalendar(),</span>
<span class="nc" id="L170">                        onSearchOnMap = { event -&gt; callback.searchOnMaps(event) },</span>
<span class="nc" id="L171">                        enableSearchOnMap = callback.enableSearchOnMap(),</span>
<span class="nc" id="L172">                        onSpotListClick = { c -&gt; callback.showSpotList(c) },</span>
<span class="nc" id="L173">                        onDonorClick = { callback.showDonorInfo() },</span>
<span class="nc" id="L174">                        onSettingsClick = { model.changeUiState(UiState.Settings) },</span>
<span class="nc" id="L175">                        onReviewSource = { c -&gt; callback.reviewSource(c) },</span>
<span class="nc" id="L176">                        onFacebookClick = { c -&gt; callback.showFacebookPages(c) },</span>
                        onReviewIgnore = {
<span class="nc bnc" id="L178" title="All 2 branches missed.">                            callback.reviewComplete(selected.value ?: center.main())</span>
<span class="nc" id="L179">                        },</span>
<span class="nc" id="L180">                        onReviewPolicy = { callback.reviewPrivacy() },</span>
<span class="nc" id="L181">                        showReviewPolicy = review.value,</span>
                    )

                UiState.Spots -&gt;
<span class="nc" id="L185">                    SpotListUi(</span>
<span class="nc" id="L186">                        list = cities.value,</span>
<span class="nc" id="L187">                        modifier = Modifier.fillMaxSize(),</span>
<span class="nc" id="L188">                        onBackPress = { callback.pressBack() },</span>
<span class="nc" id="L189">                        onSpotClick = { info -&gt; callback.showSpotInfo(info) },</span>
<span class="nc" id="L190">                        onCityClick = { c -&gt; model.changeCity(c.cityId) },</span>
<span class="nc" id="L191">                        selectedCity = city.value,</span>
                    )

                UiState.Settings -&gt;
<span class="nc" id="L195">                    SettingsUi(</span>
<span class="nc" id="L196">                        modifier = Modifier.fillMaxSize(),</span>
<span class="nc" id="L197">                        onBackPress = { callback.pressBack() },</span>
<span class="nc" id="L198">                        version = callback.versionInfo(),</span>
<span class="nc" id="L199">                        onReview = { title, asset -&gt; callback.showAssetInDialog(title, asset) },</span>
<span class="nc" id="L200">                        showChangeLog = callback.enableVersionSummary(),</span>
                    )

                else -&gt;
<span class="fc" id="L204">                    Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {</span>
<span class="pc bpc" id="L205" title="3 of 4 branches missed.">                        CircularProgressIndicator(color = MaterialTheme.colorScheme.primary)</span>
<span class="pc" id="L206">                    }</span>
<span class="fc" id="L207">            }</span>
<span class="pc" id="L208">        }</span>
<span class="fc" id="L209">    }</span>
<span class="fc" id="L210">}</span>

/**
 * A data collection for compose preview and debug.
 */
@DebugOnlyNoCoverage
object PreviewSample {
    val selectedCenter = BloodCenter.Center(
        name = &quot;Tainan Center&quot;,
        id = 5,
        cityIds = &quot;26,23,24&quot;,
        cities = &quot;Tainan and Chiayi&quot;,
    )

    val centers = listOf(
        BloodCenter.Center(
            name = &quot;Taipei Center&quot;,
            id = 2,
            cityIds = &quot;13,14,12,32,31&quot;,
            cities = &quot;Northern Taiwan&quot;,
        ),
        BloodCenter.Center(
            name = &quot;Hsinchu Center&quot;,
            id = 2,
            cityIds = &quot;16,17,15,18&quot;,
            cities = &quot;Northern Taiwan other areas&quot;,
        ),
        BloodCenter.Center(
            name = &quot;Taichung Center&quot;,
            id = 2,
            cityIds = &quot;19,21,22,33&quot;,
            cities = &quot;Central Taiwan&quot;,
        ),
        selectedCenter,
        BloodCenter.Center(
            name = &quot;Kao Center&quot;,
            id = 6,
            cityIds = &quot;27,29,34,30&quot;,
            cities = &quot;Southern Taiwan&quot;,
        )
    )

    fun storage(a: Int = 3, b: Int = 3, o: Int = 3, ab: Int = 3): HashMap&lt;String, Int&gt; =
        HashMap&lt;String, Int&gt;().apply {
            put(&quot;A&quot;, a)
            put(&quot;B&quot;, b)
            put(&quot;O&quot;, o)
            put(&quot;AB&quot;, ab)
        }

    val donations = listOf(
        DonateDay(
            activities = listOf(
                DonateActivity(&quot;Protective Service Occupations&quot;, &quot;3535 Clousson Road&quot;),
                DonateActivity(&quot;Foreman &amp; Clark&quot;, &quot;Sacramento, California&quot;),
                DonateActivity(&quot;Climer&quot;, &quot;Lake Worth, FL&quot;),
                DonateActivity(&quot;Higginbotham Rd&quot;, &quot;Georgetown, South Carolina&quot;),
            )
        ),
        DonateDay(activities = listOf()), // put an empty list for test
        DonateDay(
            activities = listOf(
                DonateActivity(&quot;De-Jaiz Mens Clothing&quot;, &quot;439 Wines Lane, Houston&quot;),
                DonateActivity(&quot;High school&quot;, &quot;377 Saint James Drive, Harrisburg, Pennsylvania&quot;),
            )
        ),
        DonateDay(
            activities = listOf(
                DonateActivity(&quot;Cleveland&quot;, &quot;715 Lakeland Park Drive&quot;),
                DonateActivity(&quot;La Luz, New Mexico&quot;, &quot;745 Reynolds StGreen River, Wyoming&quot;),
            )
        ),
        DonateDay(
            activities = listOf(
                DonateActivity(&quot;Middle Ground Church&quot;, &quot;SW Garden LnTopeka, Kansas&quot;),
                DonateActivity(&quot;Johnson Lake&quot;, &quot;San Gabriel, California&quot;),
                DonateActivity(&quot;Lynn School&quot;, &quot;Bluejacket, Oklahoma&quot;),
                DonateActivity(&quot;Patriots&quot;, &quot;404 Quartz Rd, Superior, Montana&quot;),
            )
        )
    )

    val spots = listOf(
        SpotList(10).apply {
            cityName = &quot;Sweetie&quot;
            addStaticLocation(SpotInfo(1, 10, &quot;Here some place&quot;))
            addStaticLocation(SpotInfo(2, 10, &quot;One more place&quot;))
            addStaticLocation(SpotInfo(3, 10, &quot;Last place&quot;))
            addDynamicLocation(SpotInfo(11, 10, &quot;Somewhere&quot;))
            addDynamicLocation(SpotInfo(12, 10, &quot;Nowhere&quot;))
        },
        SpotList(20).apply {
            cityName = &quot;Moon&quot;
            addStaticLocation(SpotInfo(1, 10, &quot;Here and there&quot;))
            addDynamicLocation(SpotInfo(2, 10, &quot;Far far away&quot;))
            addDynamicLocation(SpotInfo(3, 10, &quot;Far far far away&quot;))
        },
    )
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>