<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AppDataModel.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">dolphin.android.apps.BloodServiceApp</a> &gt; <span class="el_source">AppDataModel.kt</span></div><h1>AppDataModel.kt</h1><pre class="source lang-java linenums">package dolphin.android.apps.BloodServiceApp

import android.util.SparseArray
import androidx.lifecycle.LiveData
import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.SavedStateHandle
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import dolphin.android.apps.BloodServiceApp.provider.BloodCenter
import dolphin.android.apps.BloodServiceApp.provider.BloodDataParser
import dolphin.android.apps.BloodServiceApp.provider.DonateDay
import dolphin.android.apps.BloodServiceApp.provider.SpotList
import dolphin.android.apps.BloodServiceApp.ui.UiState
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.SharingStarted
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.flow
import kotlinx.coroutines.flow.flowOn
import kotlinx.coroutines.flow.stateIn

/**
 * App data [ViewModel] in [SavedStateHandle].
 *
 * @param savedState saved app state
 */
<span class="fc" id="L27">class AppDataModel(private val savedState: SavedStateHandle) : ViewModel() {</span>
    companion object {
        private const val KEY_UI_STATE = &quot;ui_state&quot;
    }

    /**
     * A flag of app about Firebase RemoteConfig load up.
     */
<span class="fc" id="L35">    val ready = MutableLiveData(false)</span>

    /**
     * A flag of app about system dark mode is enabled or not
     */
<span class="fc" id="L40">    val darkMode = MutableStateFlow(false)</span>

    /**
     * A flag to show privacy review
     */
<span class="fc" id="L45">    val showPrivacyReview = MutableStateFlow(false)</span>

    /**
     * App UI state.
     */
<span class="fc" id="L50">    val uiState: LiveData&lt;UiState&gt; = savedState.getLiveData(KEY_UI_STATE)</span>

    /**
     * Internal app ui state
     */
    var state: UiState
<span class="fc bfc" id="L56" title="All 2 branches covered.">        get() = uiState.value ?: UiState.Main</span>
        private set(value) {
<span class="fc" id="L58">            savedState.set(KEY_UI_STATE, value)</span>
<span class="fc" id="L59">        }</span>

    /**
     * Change app ui state
     *
     * @param state target app ui state
     */
    fun changeUiState(state: UiState) {
<span class="fc" id="L67">        this.state = state</span>
<span class="fc" id="L68">    }</span>

    /**
     * Selected blood center
     */
<span class="fc" id="L73">    val center = MutableLiveData&lt;BloodCenter.Center&gt;()</span>

    /**
     * Initialize the parser and other data instance.
     *
     * @param parser a helper instance to read data from internet
     * @return true if helper is ready
     */
<span class="fc" id="L81">    fun init(parser: BloodDataParser): StateFlow&lt;Boolean&gt; = flow {</span>
<span class="fc" id="L82">        parser.warmUp()</span>
<span class="fc" id="L83">        emit(true)</span>
<span class="fc" id="L84">    }.flowOn(Dispatchers.IO).stateIn(</span>
<span class="fc" id="L85">        scope = viewModelScope,</span>
<span class="fc" id="L86">        started = SharingStarted.Eagerly,</span>
<span class="fc" id="L87">        initialValue = false,</span>
<span class="fc" id="L88">    )</span>

    private var storageCache: SparseArray&lt;HashMap&lt;String, Int&gt;&gt;? = null

    /**
     * Get storage data from internet
     *
     * @param parser a helper instance to read data from internet
     * @param forceRefresh true if we want to download latest data from internet
     * @return true if update is in progressing
     */
<span class="fc" id="L99">    fun getStorageData(</span>
        parser: BloodDataParser,
<span class="fc" id="L101">        forceRefresh: Boolean = false,</span>
<span class="fc" id="L102">        centerId: Int? = -1,</span>
<span class="fc" id="L103">    ): StateFlow&lt;Boolean&gt; = flow {</span>
<span class="fc bfc" id="L104" title="All 4 branches covered.">        if (storageCache == null || forceRefresh) {</span>
<span class="fc" id="L105">            emitStorageMap(HashMap()) // clear the list</span>
<span class="fc" id="L106">            storageCache = parser.getBloodStorage(forceRefresh)</span>
        }
<span class="pc bpc" id="L108" title="2 of 4 branches missed.">        storageCache?.let { cache -&gt;</span>
<span class="pc bpc" id="L109" title="1 of 4 branches missed.">            centerId?.let { id -&gt; emitStorageMap(cache[id] ?: HashMap()) }</span>
<span class="nc" id="L110">        } ?: kotlin.run {</span>
<span class="nc" id="L111">            emitStorageMap(HashMap())</span>
<span class="nc" id="L112">        }</span>
<span class="fc" id="L113">        emit(false)</span>
<span class="fc" id="L114">    }.flowOn(Dispatchers.IO).stateIn(</span>
<span class="fc" id="L115">        scope = viewModelScope,</span>
<span class="fc" id="L116">        started = SharingStarted.Eagerly,</span>
<span class="fc" id="L117">        initialValue = true,</span>
<span class="fc" id="L118">    )</span>

<span class="fc" id="L120">    private val storages = MutableStateFlow&lt;HashMap&lt;String, Int&gt;&gt;(HashMap())</span>

    /**
     * A storage cache live data to update compose ui.
     */
<span class="fc" id="L125">    val storageMap: StateFlow&lt;HashMap&lt;String, Int&gt;&gt; = storages</span>

    /**
     * Update storage data to compose ui.
     *
     * @param maps target blood center storage
     */
    private suspend fun emitStorageMap(maps: HashMap&lt;String, Int&gt;) {
<span class="fc" id="L133">        storages.emit(maps)</span>
<span class="fc" id="L134">    }</span>

<span class="fc" id="L136">    private var donationCache = SparseArray&lt;List&lt;DonateDay&gt;&gt;()</span>

    /**
     * Get donation list from internet.
     *
     * @param parser a helper instance to read data from internet
     * @param id target blood center id
     * @return true if update is in progressing
     */
<span class="fc" id="L145">    fun getDonationData(</span>
        parser: BloodDataParser,
<span class="pc bpc" id="L147" title="2 of 4 branches missed.">        id: Int = center.value?.id ?: -1</span>
<span class="fc" id="L148">    ): StateFlow&lt;Boolean&gt; = flow {</span>
<span class="fc bfc" id="L149" title="All 2 branches covered.">        if (donationCache[id] == null) {</span>
<span class="fc" id="L150">            _daysList.emit(ArrayList()) // clear the list</span>
<span class="fc" id="L151">            donationCache.put(id, parser.getLatestWeekCalendar(id))</span>
        }
<span class="fc" id="L153">        _daysList.emit(donationCache[id])</span>
<span class="fc" id="L154">        emit(false)</span>
<span class="fc" id="L155">    }.flowOn(Dispatchers.IO).stateIn(</span>
<span class="fc" id="L156">        scope = viewModelScope,</span>
<span class="fc" id="L157">        started = SharingStarted.Eagerly,</span>
<span class="fc" id="L158">        initialValue = true,</span>
<span class="fc" id="L159">    )</span>

<span class="fc" id="L161">    private val _daysList = MutableStateFlow&lt;List&lt;DonateDay&gt;&gt;(ArrayList())</span>

    /**
     * A donation list live data to update compose ui.
     */
<span class="fc" id="L166">    val daysList: StateFlow&lt;List&lt;DonateDay&gt;&gt; = _daysList</span>

<span class="fc" id="L168">    private val spotCityCache = SparseArray&lt;ArrayList&lt;SpotList&gt;&gt;()</span>

    /**
     * Get donation spot list from internet.
     *
     * @param parser a helper instance to read data from internet
     * @param id target blood center id
     * @return true if update is in progressing
     */
<span class="fc" id="L177">    fun getSpotListData(</span>
        parser: BloodDataParser,
<span class="pc bpc" id="L179" title="2 of 4 branches missed.">        id: Int = center.value?.id ?: -1</span>
<span class="fc" id="L180">    ): StateFlow&lt;Boolean&gt; = flow {</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">        if (spotCityCache[id] == null) {</span>
<span class="fc" id="L182">            val list = ArrayList&lt;SpotList&gt;()</span>
<span class="fc" id="L183">            emitSpotList(list) // clear the list</span>

<span class="fc" id="L185">            val (order, data) = parser.getDonationSpotLocationMap(id)</span>
<span class="fc" id="L186">            order.forEach { id -&gt; list.add(data.get(id)) }</span>
<span class="fc" id="L187">            spotCityCache.put(id, list)</span>
        }
<span class="fc" id="L189">        emitSpotList(list = spotCityCache[id])</span>
<span class="fc" id="L190">        emit(false)</span>
<span class="fc" id="L191">    }.flowOn(Dispatchers.IO).stateIn(</span>
<span class="fc" id="L192">        scope = viewModelScope,</span>
<span class="fc" id="L193">        started = SharingStarted.Eagerly,</span>
<span class="fc" id="L194">        initialValue = true,</span>
<span class="fc" id="L195">    )</span>

<span class="fc" id="L197">    private val _spotList = MutableStateFlow&lt;List&lt;SpotList&gt;&gt;(ArrayList())</span>

    /**
     * A spot list live data to update compose ui.
     */
<span class="fc" id="L202">    val spotList: StateFlow&lt;List&lt;SpotList&gt;&gt; = _spotList</span>

    /**
     * Update spot list to compose ui.
     *
     * @param list spot list of target blood center
     */
    private suspend fun emitSpotList(list: List&lt;SpotList&gt;) {
<span class="fc" id="L210">        _spotList.emit(list)</span>
<span class="fc bfc" id="L211" title="All 4 branches covered.">        currentCity.emit(if (list.isNotEmpty()) list.first().cityId else 0)</span>
<span class="fc" id="L212">    }</span>

<span class="fc" id="L214">    private val currentCity = MutableStateFlow(0)</span>

    /**
     * Current selected city. Only useful in SpotListUi.
     */
<span class="fc" id="L219">    val city: StateFlow&lt;Int&gt; = currentCity</span>

    /**
     * Change a new city
     *
     * @param cityId new city
     */
    fun changeCity(cityId: Int) {
<span class="fc" id="L227">        currentCity.value = cityId</span>
<span class="fc" id="L228">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>