<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BloodDataReader.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">dolphin.android.apps.BloodServiceApp.provider</a> &gt; <span class="el_source">BloodDataReader.kt</span></div><h1>BloodDataReader.kt</h1><pre class="source lang-java linenums">package dolphin.android.apps.BloodServiceApp.provider

import android.util.Log
import okhttp3.OkHttpClient
import okhttp3.Request
import okhttp3.Response
import java.io.IOException
import java.text.SimpleDateFormat
import java.util.Calendar
import java.util.Locale
import java.util.concurrent.TimeUnit

/**
 * Reader interface
 */
interface BloodDataReader {
    /**
     * Warmup browser and cache
     */
    fun warmUp()

    /**
     * Read html content of blood storage in each center
     *
     * @return html content
     */
    fun readBloodStorage(): String

    /**
     * Read html content of donation week calendar
     *
     * @param id blood center id
     * @param weekDay first day of the week
     * @return html content
     */
    fun readWeekCalendar(id: Int, weekDay: Calendar): String

    /**
     * Read html content of donation location list
     *
     * @param centerId blood center id
     * @param cityId city id
     * @param url city stations url
     * @return html content
     */
    fun readDonationSpotList(centerId: Int, cityId: Int, url: String): String
}

/**
 * Default implementation of providing data for parser. It will read data from website.
 *
 * @param timeout timeout in seconds
 */
<span class="fc" id="L54">open class BloodDataReaderImpl(timeout: Long = 5) : BloodDataReader {</span>
    companion object {
        private const val TAG = &quot;BloodDataReader&quot;
    }

<span class="fc" id="L59">    private val client: OkHttpClient = OkHttpClient.Builder()</span>
<span class="fc" id="L60">        .connectTimeout(timeout, TimeUnit.SECONDS) // connect timeout</span>
<span class="fc" id="L61">        .readTimeout(timeout, TimeUnit.SECONDS) // socket timeout</span>
<span class="fc" id="L62">        .build()</span>

    override fun warmUp() {
<span class="fc" id="L65">        val request: Request = Request.Builder()</span>
<span class="fc" id="L66">            .url(BloodCenter.URL_BASE_BLOOD_ORG + &quot;/robots.txt&quot;)</span>
<span class="fc" id="L67">            .get()</span>
<span class="fc" id="L68">            .build()</span>
<span class="fc" id="L69">        try {</span>
<span class="fc" id="L70">            client.newCall(request).execute()</span>
<span class="nc" id="L71">        } catch (e: IOException) {</span>
<span class="nc" id="L72">            Log.e(TAG, &quot;warm: &quot; + e.message)</span>
        }
<span class="fc" id="L74">    }</span>

    protected open fun body(url: String): String {
<span class="fc" id="L77">        val request: Request = Request.Builder().url(url).build()</span>
        val response: Response
<span class="fc" id="L79">        return try {</span>
<span class="fc" id="L80">            response = client.newCall(request).execute()</span>
<span class="pc bpc" id="L81" title="2 of 4 branches missed.">            return response.body?.string() ?: &quot;&quot;</span>
<span class="fc" id="L82">        } catch (e: IOException) {</span>
<span class="fc" id="L83">            e.printStackTrace()</span>
<span class="fc" id="L84">            Log.e(TAG, String.format(&quot;%s from %s&quot;, e.message, url))</span>
<span class="fc" id="L85">            &quot;(io)&quot;</span>
<span class="nc" id="L86">        } catch (e: NullPointerException) {</span>
<span class="nc" id="L87">            Log.e(TAG, &quot;null pointer exception&quot;)</span>
<span class="pc" id="L88">            &quot;(null)&quot;</span>
        }
    }

    override fun readBloodStorage(): String {
<span class="fc" id="L93">        return body(BloodCenter.URL_BLOOD_STORAGE)</span>
    }

    override fun readWeekCalendar(id: Int, weekDay: Calendar): String {
        // make sure it is Sunday
<span class="fc bfc" id="L98" title="All 2 branches covered.">        while (weekDay[Calendar.DAY_OF_WEEK] != Calendar.SUNDAY) {</span>
<span class="fc" id="L99">            weekDay.add(Calendar.DAY_OF_WEEK, -1)</span>
        }
<span class="fc" id="L101">        val day = SimpleDateFormat(&quot;yyyy/MM/dd&quot;, Locale.TAIWAN).format(weekDay.time)</span>
<span class="fc" id="L102">        val url = BloodCenter.URL_LOCAL_BLOOD_CENTER_WEEK</span>
<span class="fc" id="L103">            .replace(&quot;{site}&quot;, id.toString())</span>
<span class="fc" id="L104">            .replace(&quot;{date}&quot;, day)</span>
<span class="fc" id="L105">        return body(url)</span>
    }

    override fun readDonationSpotList(centerId: Int, cityId: Int, url: String): String {
        // val url = (endpoint + BloodCenter.QS_LOCATION_MAP_CITY).replace(&quot;{city}&quot;, cityId)
<span class="fc" id="L110">        return body(url)</span>
    }
<span class="fc" id="L112">}</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>